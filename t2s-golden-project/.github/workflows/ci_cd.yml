name: CI_CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

env:
  APP_NAME: express-t2s
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (if app is Node)
        working-directory: app
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found in app/. Skipping npm ci."
          fi

      - name: Run tests (optional)
        working-directory: app
        run: |
          if [ -f package.json ]; then
            npm test --if-present
          else
            echo "No tests configured."
          fi

  docker-build:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker build
        run: |
          if [ -f app/Dockerfile ]; then
            docker build -t $APP_NAME:$IMAGE_TAG -f app/Dockerfile app
          else
            echo "No app/Dockerfile found. Add one to enable image builds."
          fi

      - name: Security scan (Trivy) - optional
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: '${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}'
          format: 'table'
        continue-on-error: true

  gitops-update-dev:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update GitOps dev image tag
        run: |
          # This updates the dev environment values file in gitops/
          # In production, you'd typically update a separate GitOps repo via PR.
          FILE="gitops/environments/dev/values.yaml"
          if [ -f "$FILE" ]; then
            echo "Updating $FILE image.tag to ${IMAGE_TAG}"
            sed -i "s/^  tag: .*/  tag: \"${IMAGE_TAG}\"/" "$FILE" || true
          else
            echo "GitOps values file not found at $FILE"
            exit 1
          fi

      - name: Create Pull Request (recommended flow)
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(gitops): bump dev image tag to ${{ env.IMAGE_TAG }}"
          title: "GitOps: bump dev image tag"
          body: |
            This PR updates the dev environment image tag for ${{ env.APP_NAME }}.
            - Image tag: ${{ env.IMAGE_TAG }}
          branch: "gitops/bump-dev-${{ env.IMAGE_TAG }}"
