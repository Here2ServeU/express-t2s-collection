# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ main ]

# env:
#   AWS_REGION: us-east-1                   # Update to your region
#   ECR_REPOSITORY: express-t2s-app-repo    # Matches your REPO_NAME in script
#   ECS_CLUSTER: express-t2s-app-cluster    # Matches your terraform cluster name
#   ECS_SERVICE: express-t2s-app-service    # Matches your terraform service name

# jobs:
#   # 1. Provision Infrastructure
#   provision-infra:
#     name: Provision AWS Infrastructure
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4

#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3

#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Terraform Init & Apply
#         working-directory: ./terraform  # Path to your .tf files
#         run: |
#           terraform init
#           terraform apply -auto-approve

#   # 2. Build, Tag, and Push using your script
#   build-and-push:
#     name: Build and Push Image
#     needs: provision-infra
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4

#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Run Build and Push Script
#         run: |
#           chmod +x ./scripts/build_and_push.sh
#           ./scripts/build_and_push.sh
#         env:
#           AWS_REGION: ${{ env.AWS_REGION }}
#           REPO_NAME: ${{ env.ECR_REPOSITORY }}

#   # 3. Deploy to ECS
#   deploy-ecs:
#     name: Deploy to Amazon ECS
#     needs: build-and-push
#     runs-on: ubuntu-latest
#     steps:
#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Update ECS Service
#         run: |
#           aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} \
#                                --service ${{ env.ECS_SERVICE }} \
#                                --force-new-deployment
